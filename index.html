<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planchis Online</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, #00b050, #1aa3ff, #ff1493, #ffde00);
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #555;
        }
        
        .card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 16px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .card-body p {
            margin-bottom: 1.5rem;
        }
        
        .btn {
            display: block;
            width: 100%;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.8rem;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }
        
        .btn:hover {
            background-color: #3367d6;
        }
        
        .green-bg {
            background-color: #00b050;
        }
        
        .blue-bg {
            background-color: #1aa3ff;
        }
        
        .pink-bg {
            background-color: #ff1493;
        }
        
        .yellow-bg {
            background-color: #ffde00;
            color: #333;
        }
        
        .server-status {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #ccc;
        }
        
        .status-online {
            background-color: #00b050;
        }
        
        .status-offline {
            background-color: #ff3b30;
        }
        
        .status-checking {
            background-color: #ffcc00;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .games-list {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .games-list h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .games-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .games-table th, .games-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .games-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .games-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .join-btn {
            background-color: #00b050;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .join-btn:hover {
            background-color: #009040;
        }
        
        .refresh-btn {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: background-color 0.3s ease;
        }
        
        .refresh-btn:hover {
            background-color: #e5e5e5;
        }
        
        .share-section {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .share-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
        }
        
        .share-link {
            display: block;
            padding: 0.8rem;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 1rem;
            word-break: break-all;
            font-family: monospace;
            text-align: center;
        }
        
        .copy-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .copy-btn:hover {
            background-color: #3367d6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }
        
        .cancel-btn {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
        }
        
        .cancel-btn:hover {
            background-color: #e5e5e5;
        }
        
        .submit-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.8rem 1.5rem;
            cursor: pointer;
        }
        
        .submit-btn:hover {
            background-color: #3367d6;
        }
        
        .no-games {
            text-align: center;
            padding: 2rem;
            color: #777;
        }
        
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: 3rem;
        }
        
        footer a {
            color: #adf;
            text-decoration: none;
        }
        
        footer a:hover {
            text-decoration: underline;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .card-container {
                flex-direction: column;
                align-items: center;
            }
            
            .card {
                width: 100%;
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Planchis Online</h1>
        <p>El juego ancestral de astrología y estrategia</p>
    </header>
    
    <div class="container">
        <div class="server-status">
            <span class="status-indicator status-checking" id="server-indicator"></span>
            <span id="server-status-text">Comprobando estado del servidor...</span>
        </div>
        
        <div class="hero">
            <h1>¡Bienvenido a Planchis Online!</h1>
            <p>Disfruta del tradicional juego de mesa en su versión digital. Compite contra otros jugadores o contra la máquina en este fascinante juego de estrategia.</p>
        </div>
        
        <div class="card-container">
            <div class="card">
                <div class="card-header green-bg">
                    Jugar Solo
                </div>
                <div class="card-body">
                    <p>Juega inmediatamente contra la máquina. Práctica perfecta para dominar el juego.</p>
                    <button class="btn" id="play-solo-btn-2">2 Jugadores</button>
                    <button class="btn" style="margin-top: 0.5rem;" id="play-solo-btn-4">4 Jugadores</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header blue-bg">
                    Multijugador
                </div>
                <div class="card-body">
                    <p>Crea una partida para jugar con amigos o únete a una partida existente.</p>
                    <button class="btn" id="create-game-btn">Crear Partida</button>
                    <button class="btn" style="margin-top: 0.5rem;" id="show-games-btn">Unirse a Partida</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header pink-bg">
                    Manual del Juego
                </div>
                <div class="card-body">
                    <p>Aprende las reglas del juego, estrategias y consejos para convertirte en un maestro de Planchis.</p>
                    <a href="manual.html" class="btn">Leer Manual</a>
                </div>
            </div>
        </div>
        
        <div class="games-list" id="games-list" style="display: none;">
            <h3>Partidas Disponibles</h3>
            <button class="refresh-btn" id="refresh-games-btn">↻ Actualizar Lista</button>
            <div id="games-table-container">
                <table class="games-table" id="games-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Anfitrión</th>
                            <th>Jugadores</th>
                            <th>Modo</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="games-table-body">
                        <!-- Los juegos disponibles se añadirán aquí dinámicamente -->
                    </tbody>
                </table>
                <div class="no-games" id="no-games-message" style="display: none;">
                    No hay partidas disponibles. ¡Crea una nueva partida!
                </div>
            </div>
        </div>
        
        <div class="share-section" id="share-section" style="display: none;">
            <h3>Comparte el enlace con tus amigos</h3>
            <div class="share-link" id="share-link"></div>
            <button class="copy-btn" id="copy-link-btn">Copiar Enlace</button>
        </div>
    </div>
    
    <!-- Modal para crear partida -->
    <div class="modal" id="create-game-modal">
        <div class="modal-content">
            <h2 class="modal-title">Crear Nueva Partida</h2>
            <div class="form-group">
                <label for="player-name">Tu Nombre:</label>
                <input type="text" id="player-name" placeholder="Ingresa tu nombre" maxlength="20">
            </div>
            <div class="form-group">
                <label for="game-mode">Modo de Juego:</label>
                <select id="game-mode">
                    <option value="2">2 Jugadores</option>
                    <option value="4">4 Jugadores</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancel-create-btn">Cancelar</button>
                <button class="submit-btn" id="submit-create-btn">Crear Partida</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para unirse a partida -->
    <div class="modal" id="join-game-modal">
        <div class="modal-content">
            <h2 class="modal-title">Unirse a Partida</h2>
            <div class="form-group">
                <label for="join-player-name">Tu Nombre:</label>
                <input type="text" id="join-player-name" placeholder="Ingresa tu nombre" maxlength="20">
            </div>
            <div class="form-group">
                <label>Partida seleccionada:</label>
                <p id="selected-game-info">Ninguna partida seleccionada</p>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancel-join-btn">Cancelar</button>
                <button class="submit-btn" id="submit-join-btn">Unirse a Partida</button>
            </div>
        </div>
    </div>
    
    <!-- Modal con código para integrar el juego en tu web -->
    <div class="modal" id="embed-modal">
        <div class="modal-content">
            <h2 class="modal-title">Integrar en tu sitio web</h2>
            <p>Copia este código HTML para integrar Planchis en tu web:</p>
            <div class="form-group">
                <textarea id="embed-code" rows="5" readonly style="width: 100%; padding: 10px; font-family: monospace; resize: none;">&lt;iframe src="https://planchis.izarren.top" width="100%" height="700" frameborder="0" style="max-width: 1200px;" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"&gt;&lt;/iframe&gt;</textarea>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" id="close-embed-btn">Cerrar</button>
                <button class="submit-btn" id="copy-embed-btn">Copiar Código</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Planchis Online &copy; 2025 | <a href="https://www.izarren.top" target="_blank">www.izarren.top</a> | <a href="#" id="show-embed-btn">Integrar en tu web</a></p>
    </footer>
    
    <script>
        // Soporte para iframe - permitir que el juego funcione incrustado
        // Configuración para comunicación entre el iframe y la página principal
        window.inIframe = window !== window.top;
        
        // Sistema de almacenamiento que funciona tanto en iframe como fuera
        const storage = {
            getItem: function(key) {
                // Intentar usar localStorage si está disponible
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.log('localStorage no disponible, usando almacenamiento en memoria');
                    // Fallback a almacenamiento en memoria
                    if (!this.memoryStorage) this.memoryStorage = {};
                    return this.memoryStorage[key] || null;
                }
            },
            setItem: function(key, value) {
                // Intentar usar localStorage si está disponible
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.log('localStorage no disponible, usando almacenamiento en memoria');
                    // Fallback a almacenamiento en memoria
                    if (!this.memoryStorage) this.memoryStorage = {};
                    this.memoryStorage[key] = value;
                }
                
                // Si estamos en un iframe, también comunicar a la página principal
                if (window.inIframe && window.parent) {
                    try {
                        window.parent.postMessage({
                            type: 'planchisStorage',
                            key: key,
                            value: value
                        }, '*');
                    } catch (e) {
                        console.log('No se pudo comunicar con la página principal', e);
                    }
                }
            }
        };
        
        // Escuchar mensajes desde la página principal
        window.addEventListener('message', function(event) {
            // Verificar que el mensaje es para nosotros
            if (event.data && event.data.type === 'planchisMessage') {
                console.log('Mensaje recibido de la página principal:', event.data);
                // Aquí puedes procesar mensajes específicos
            }
        });

function fixWebSocketHandshake() {
  // Forzar los encabezados correctos para el handshake WebSocket
  const originalWebSocket = window.WebSocket;
  
  // Reemplazar temporalmente el constructor de WebSocket
  window.WebSocket = function(url, protocols) {
    console.log('Creando WebSocket con URL:', url);
    
    // Hacer la URL relativa si estamos en producción
    const isSecure = window.location.protocol === 'https:';
    if (isSecure && url.startsWith('wss://')) {
      // Convertir a URL relativa para evitar problemas de CORS
      const host = window.location.host;
      if (url.includes(host)) {
        url = `//${host}`;
        console.log('URL ajustada:', url);
      }
    }
    
    // Llamar al constructor original
    return new originalWebSocket(url, protocols);
  };
  
  // Mantener las propiedades del prototype original
  window.WebSocket.prototype = originalWebSocket.prototype;
  window.WebSocket.CONNECTING = originalWebSocket.CONNECTING;
  window.WebSocket.OPEN = originalWebSocket.OPEN;
  window.WebSocket.CLOSING = originalWebSocket.CLOSING;
  window.WebSocket.CLOSED = originalWebSocket.CLOSED;

        
        // Configuración optimizada de WebSocket para Render
        function getWebSocketUrl() {
            // Detectar si estamos en localhost o en producción
            const isLocalhost = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                // En desarrollo local, usar el puerto 8765
                return 'ws://localhost:8765';
            } else {
                // En producción (Render), usar wss con el hostname completo
                const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                
                // Usar el nombre de host completo sin path adicional
                const hostname = window.location.host;
                return `${protocol}://${hostname}`;
            }
        }

        function connectWithRetry(maxRetries = 5, retryInterval = 3000) {
            let retryCount = 0;
            
            function attemptConnection() {
                console.log(`Intento de conexión ${retryCount + 1}/${maxRetries}`);
                
                const WS_URL = getWebSocketUrl();
                console.log('Conectando a WebSocket:', WS_URL);
                
                // Actualizar indicador visual
                const serverIndicator = document.getElementById('server-indicator');
                const serverStatusText = document.getElementById('server-status-text');
                
                if (serverIndicator && serverStatusText) {
                    serverIndicator.className = 'status-indicator status-checking';
                    serverStatusText.textContent = 'Conectando al servidor...';
                }
                
                // Cerrar websocket existente si hay uno
                if (websocket && websocket.readyState !== WebSocket.CLOSED) {
                    websocket.close();
                }
                
                // Crear nueva conexión
                try {
                    websocket = new WebSocket(WS_URL);
                    
                    websocket.onopen = () => {
                        console.log('Conexión WebSocket establecida');
                        if (serverIndicator && serverStatusText) {
                            serverIndicator.className = 'status-indicator status-online';
                            serverStatusText.textContent = 'Servidor online - Listo para jugar';
                        }
                        
                        // Habilitar botones si existen
                        enableButtons();
                        
                        // Iniciar ping periódico
                        startPingInterval();
                        
                        // Reiniciar contador de intentos
                        retryCount = 0;
                        
                        // Procesar acciones pendientes tras reconexión exitosa
                        if (typeof processReconnection === 'function') {
                            processReconnection();
                        }
                    };
                    
                    websocket.onclose = (event) => {
                        console.log('Conexión WebSocket cerrada', event);
                        
                        if (serverIndicator && serverStatusText) {
                            serverIndicator.className = 'status-indicator status-offline';
                            serverStatusText.textContent = 'Sin conexión - Modo local activo';
                        }
                        
                        // Detener ping
                        stopPingInterval();
                        
                        // Deshabilitar botones que requieren servidor
                        disableOnlineButtons();
                        
                        // Reintentar si no hemos alcanzado el máximo
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Reintentando conexión en ${retryInterval/1000} segundos...`);
                            setTimeout(attemptConnection, retryInterval);
                        } else {
                            console.log('Máximo de reintentos alcanzado, cambiando a modo local');
                            if (serverStatusText) {
                                serverStatusText.textContent = 'Sin conexión - Modo local permanente';
                            }
                        }
                    };
                    
                    websocket.onerror = (error) => {
                        console.error('Error en WebSocket:', error);
                    };
                    
                    websocket.onmessage = handleServerMessage;
                    
                } catch (error) {
                    console.error('Error al crear WebSocket:', error);
                    
                    // Reintentar
                    if (retryCount < maxRetries) {
                        retryCount++;
                        setTimeout(attemptConnection, retryInterval);
                    }
                }
            }
            
            // Funciones auxiliares para habilitar/deshabilitar botones
            function enableButtons() {
                // En index.html
                const createGameBtn = document.getElementById('create-game-btn');
                const showGamesBtn = document.getElementById('show-games-btn');
                
                if (createGameBtn) createGameBtn.disabled = false;
                if (showGamesBtn) showGamesBtn.disabled = false;
                
                // En planchis.html - botones específicos del juego
                const rollDiceBtn = document.getElementById('roll-dice');
                if (rollDiceBtn) rollDiceBtn.disabled = false;
            }
            
            function disableOnlineButtons() {
                // Deshabilitar solo botones que requieren servidor
                // Esto mantendrá habilitados los botones de juego local
                
                // Actualizar mensaje de No hay juegos si está visible
                const noGamesMessage = document.getElementById('no-games-message');
                const gamesTableBody = document.getElementById('games-table-body');
                
                if (noGamesMessage && gamesTableBody) {
                    gamesTableBody.innerHTML = '';
                    noGamesMessage.style.display = 'block';
                    noGamesMessage.textContent = 'No se pudo conectar al servidor. Puedes jugar en modo local.';
                }
            }
            
            // Iniciar primer intento
            attemptConnection();
        }
        
        function startPingInterval() {
            // Limpiar intervalo existente primero
            stopPingInterval();
            
            // Crear nuevo intervalo
            pingInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    try {
                        websocket.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
                        console.log("Ping enviado para mantener conexión");
                    } catch (error) {
                        console.error("Error enviando ping:", error);
                        // Si hay error al enviar ping, intentar reconectar
                        stopPingInterval();
                        setTimeout(() => connectWithRetry(3, 5000), 1000);
                    }
                } else {
                    console.warn("WebSocket no está abierto, no se puede enviar ping");
                    // Detener envío de pings hasta reconexión
                    stopPingInterval();
                }
            }, 25000); // Cada 25 segundos (algo menos que el tiempo típico de timeout)
        }

        function stopPingInterval() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }

        // ===== 4. MEJORA DE COMPATIBILIDAD CON IFRAME =====
        // Agregar este código al inicio de ambos archivos HTML

        function setupIframeCompatibility() {
            // Detectar si estamos en un iframe
            window.inIframe = window !== window.top;
            
            console.log('Ejecución en iframe:', window.inIframe);
            
            // Sistema de almacenamiento que funciona tanto en iframe como fuera
            window.safeStorage = {
                getItem: function(key) {
                    // Intentar usar localStorage si está disponible
                    try {
                        return localStorage.getItem(key);
                    } catch (e) {
                        console.log('localStorage no disponible, usando almacenamiento en memoria');
                        // Fallback a almacenamiento en memoria
                        if (!this.memoryStorage) this.memoryStorage = {};
                        return this.memoryStorage[key] || null;
                    }
                },
                setItem: function(key, value) {
                    // Intentar usar localStorage si está disponible
                    try {
                        localStorage.setItem(key, value);
                    } catch (e) {
                        console.log('localStorage no disponible, usando almacenamiento en memoria');
                        // Fallback a almacenamiento en memoria
                        if (!this.memoryStorage) this.memoryStorage = {};
                        this.memoryStorage[key] = value;
                    }
                    
                    // Si estamos en un iframe, también comunicar a la página principal
                    if (window.inIframe && window.parent) {
                        try {
                            window.parent.postMessage({
                                type: 'planchisStorage',
                                key: key,
                                value: value
                            }, '*');
                        } catch (e) {
                            console.log('No se pudo comunicar con la página principal', e);
                        }
                    }
                }
            };
            
            // Configurar mensajes entre iframe y página principal
            window.addEventListener('message', function(event) {
                // Verificar que el mensaje es para nosotros
                if (event.data && event.data.type && event.data.type.startsWith('planchis')) {
                    console.log('Mensaje recibido de comunicación iframe:', event.data);
                    
                    // Procesar según el tipo de mensaje
                    if (event.data.type === 'planchisStorage') {
                        // Sincronizar almacenamiento
                        try {
                            const { key, value } = event.data;
                            window.safeStorage.setItem(key, value);
                            console.log('Almacenamiento sincronizado desde la página principal:', key);
                        } catch (e) {
                            console.error('Error procesando mensaje de almacenamiento:', e);
                        }
                    }
                }
            });
        }

        // ===== 5. CONFIGURACIÓN OPTIMIZADA PARA RENDER =====
        // Añadir código para manejo de dominio en producción

        function getBaseDomain() {
            // Detectar si estamos en localhost o en algún dominio de producción
            const hostname = window.location.hostname;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:8080'; // Ajusta según tu entorno de desarrollo
            } else {
                // En producción usar el origen actual
                return window.location.origin;
            }
        }

        // Para uso al construir URLs de recursos
        function getResourceUrl(path) {
            const base = getBaseDomain();
            // Asegurarse de que el path comience con /
            const safePath = path.startsWith('/') ? path : '/' + path;
            return `${base}${safePath}`;
        }

        // ===== 6. DETECCIÓN Y MANEJO DE PROBLEMAS DE RED =====
        // Añadir detector de estado de red

        function setupNetworkDetection() {
            // Función para comprobar conectividad a internet
            function updateOnlineStatus() {
                const isOnline = navigator.onLine;
                console.log('Estado de conexión a internet:', isOnline ? 'Conectado' : 'Sin conexión');
                
                // Actualizar elementos visuales si existen
                const serverIndicator = document.getElementById('server-indicator');
                const serverStatusText = document.getElementById('server-status-text');
                
                if (!isOnline && serverIndicator && serverStatusText) {
                    serverIndicator.className = 'status-indicator status-offline';
                    serverStatusText.textContent = 'Sin conexión a internet - Modo local';
                } else if (isOnline && websocket && websocket.readyState !== WebSocket.OPEN) {
                    // Si recuperamos la conexión pero el websocket está cerrado, intentar reconectar
                    connectWithRetry(3, 2000);
                }
            }
            
            // Registrar eventos de cambio de estado de red
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Comprobar estado inicial
            updateOnlineStatus();
        }

        // ===== 7. INICIALIZACIÓN SEGURA DE LA APLICACIÓN =====
        // Añadir función de inicialización para garantizar carga correcta

        function initPlanchisApp() {
            console.log('Iniciando aplicación Planchis...');
            
            // Configurar compatibilidad con iframe
            setupIframeCompatibility();
            
            // Configurar detección de estado de red
            setupNetworkDetection();
            
            // Iniciar conexión WebSocket con reintentos
            connectWithRetry(5, 3000);
            
            // Cargar nombre de jugador guardado si existe
            const savedPlayerName = window.safeStorage.getItem('playerName');
            const playerNameInput = document.getElementById('player-name');
            const joinPlayerNameInput = document.getElementById('join-player-name');
            
            if (savedPlayerName) {
                if (playerNameInput) playerNameInput.value = savedPlayerName;
                if (joinPlayerNameInput) joinPlayerNameInput.value = savedPlayerName;
            }
            
            console.log('Inicialización de Planchis completada');
        }


// Agrega esta línea de depuración para ver qué URL se está utilizando
console.log("URL de WebSocket:", getWebSocketUrl());        // Variables globales
        let websocket = null;
        let selectedGameId = null;
        let availableGames = [];
        let createdGameId = null;
        let pingInterval = null;
        
        // Elementos DOM
        const serverIndicator = document.getElementById('server-indicator');
        const serverStatusText = document.getElementById('server-status-text');
        const createGameBtn = document.getElementById('create-game-btn');
        const showGamesBtn = document.getElementById('show-games-btn');
        const refreshGamesBtn = document.getElementById('refresh-games-btn');
        const gamesList = document.getElementById('games-list');
        const gamesTableBody = document.getElementById('games-table-body');
        const noGamesMessage = document.getElementById('no-games-message');
        const shareSection = document.getElementById('share-section');
        const shareLink = document.getElementById('share-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const playSoloBtn2 = document.getElementById('play-solo-btn-2');
        const playSoloBtn4 = document.getElementById('play-solo-btn-4');
        
        // Modales
        const createGameModal = document.getElementById('create-game-modal');
        const joinGameModal = document.getElementById('join-game-modal');
        const embedModal = document.getElementById('embed-modal');
        const cancelCreateBtn = document.getElementById('cancel-create-btn');
        const submitCreateBtn = document.getElementById('submit-create-btn');
        const cancelJoinBtn = document.getElementById('cancel-join-btn');
        const submitJoinBtn = document.getElementById('submit-join-btn');
        const selectedGameInfo = document.getElementById('selected-game-info');
        const showEmbedBtn = document.getElementById('show-embed-btn');
        const closeEmbedBtn = document.getElementById('close-embed-btn');
        const copyEmbedBtn = document.getElementById('copy-embed-btn');
        
        // Campos de formulario
        const playerNameInput = document.getElementById('player-name');
        const gameModeSelect = document.getElementById('game-mode');
        const joinPlayerNameInput = document.getElementById('join-player-name');
        const embedCode = document.getElementById('embed-code');
        
        // Función para conectar al WebSocket con reintentos
        function connectToServer() {
            const WS_URL = getWebSocketUrl();
            console.log('Conectando a WebSocket:', WS_URL);
            
            serverIndicator.className = 'status-indicator status-checking';
            serverStatusText.textContent = 'Conectando al servidor...';
            
            // Cerrar websocket existente si hay uno
            if (websocket && websocket.readyState !== WebSocket.CLOSED) {
                websocket.close();
            }
            
            try {
                websocket = new WebSocket(WS_URL);
                
                websocket.onopen = () => {
                    console.log('Conexión WebSocket establecida');
                    serverIndicator.className = 'status-indicator status-online';
                    serverStatusText.textContent = 'Servidor online - Listo para jugar';
                    
                    // Habilitar botones
                    createGameBtn.disabled = false;
                    showGamesBtn.disabled = false;
                    
                    // Iniciar ping periódico para mantener la conexión
                    startPingInterval();
                    
                    // Si estábamos mostrando la lista de juegos, actualizarla
                    if (gamesList.style.display !== 'none') {
                        fetchAvailableGames();
                    }
                    
                    // Verificar si tenemos un código de invitación
                    checkForInviteCode();
                };
                
                websocket.onclose = (event) => {
                    console.log('Conexión WebSocket cerrada', event);
                    serverIndicator.className = 'status-indicator status-offline';
                    serverStatusText.textContent = 'Sin conexión - Jugando en modo local';
                    
                    // Detener ping
                    stopPingInterval();
                    
                    // Deshabilitar botones que requieren servidor
                    // Pero dejamos habilitados los de juego local
                    if (gamesList.style.display !== 'none') {
                        gamesTableBody.innerHTML = '';
                        noGamesMessage.style.display = 'block';
                        noGamesMessage.textContent = 'No se pudo conectar al servidor. Puedes jugar en modo local.';
                    }
                    
                    // Intentar reconectar después de un tiempo
                    setTimeout(connectToServer, 5000);
                };
                
                websocket.onerror = (error) => {
                    console.error('Error en WebSocket:', error);
                    serverIndicator.className = 'status-indicator status-offline';
                    serverStatusText.textContent = 'Error de conexión - Modo local habilitado';
                };
                
                websocket.onmessage = (event) => {
                    handleServerMessage(event.data);
                };
                
            } catch (error) {
                console.error('Error al crear WebSocket:', error);
                serverIndicator.className = 'status-indicator status-offline';
                serverStatusText.textContent = 'Error de conexión - Modo local habilitado';
                
                // Intentar reconectar después de un tiempo
                setTimeout(connectToServer, 5000);
            }
        }
        
        // Iniciar envío de pings periódicos
        function startPingInterval() {
            stopPingInterval(); // Limpiar intervalo existente
            
            pingInterval = setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({ type: "ping" }));
                    console.log("Ping enviado para mantener conexión");
                }
            }, 30000); // Cada 30 segundos
        }

        // Detener envío de pings
        function stopPingInterval() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        // Detener envío de pings
        function stopPingInterval() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        // Verificar si tenemos un código de invitación en la URL
        function checkForInviteCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('gameId');
            
            if (gameId) {
                // Automáticamente mostrar modal de unirse
                selectedGameId = gameId;
                submitJoinBtn.disabled = false;
                
                // Buscar información del juego 
                fetchAvailableGames();
                
                // Mostrar modal después de un breve retraso
                setTimeout(() => {
                    // Buscar el juego en la lista
                    const game = availableGames.find(g => g.gameId === gameId);
                    if (game) {
                        selectedGameInfo.textContent = `${game.gameName || 'Partida de ' + game.host} (${game.connectedPlayers}/${game.requiredPlayers} jugadores)`;
                    } else {
                        selectedGameInfo.textContent = 'Partida encontrada. Introduce tu nombre para unirte.';
                    }
                    
                    joinGameModal.style.display = 'flex';
                }, 1000);
            }
        }
        
        // Manejar mensajes del servidor
        function handleServerMessage(message) {
            try {
                const data = JSON.parse(message);
                console.log('Mensaje recibido:', data);
                
                switch (data.type) {
                    case 'available_games':
                        updateGamesList(data.games);
                        break;
                        
                    case 'game_created':
                        // Guardar ID del juego creado
                        createdGameId = data.gameId;
                        
                        // Guardar IDs en sessionStorage para reconexión
                        sessionStorage.setItem('activeGameId', data.gameId);
                        sessionStorage.setItem('activePlayerId', data.playerId);
                        
                        // Generar enlace para compartir
                        const shareUrl = `${window.location.origin}${window.location.pathname}?gameId=${data.gameId}`;
                        shareLink.textContent = shareUrl;
                        shareSection.style.display = 'block';
                        
                        // Redirigir a la página del juego
                        window.location.href = `planchis.html?gameId=${data.gameId}&playerId=${data.playerId}`;
                        break;
                        
                    case 'game_joined':
                        // Guardar IDs en sessionStorage para reconexión
                        sessionStorage.setItem('activeGameId', data.gameId);
                        sessionStorage.setItem('activePlayerId', data.playerId);
                        
                        // Redirigir a la página del juego
                        window.location.href = `planchis.html?gameId=${data.gameId}&playerId=${data.playerId}`;
                        break;
                        
                    case 'error':
                        alert(`Error: ${data.message}`);
                        break;
                        
                    case 'pong':
                        console.log('Pong recibido del servidor');
                        break;
                }
                
            } catch (error) {
                console.error('Error al procesar mensaje:', error);
            }
        }
        
        // Obtener lista de juegos disponibles
        function fetchAvailableGames() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'get_available_games'
                }));
            } else {
                console.error('WebSocket no está conectado');
                
                // Mostrar mensaje de no hay juegos (ya que no podemos consultar)
                gamesTableBody.innerHTML = '';
                noGamesMessage.style.display = 'block';
                noGamesMessage.textContent = 'No se pudo conectar al servidor. Puedes jugar en modo local.';
            }
        }
        
        // Actualizar la lista de juegos en la UI
        function updateGamesList(games) {
            availableGames = games;
            gamesTableBody.innerHTML = '';
            
            if (games.length === 0) {
                noGamesMessage.style.display = 'block';
                return;
            }
            
            noGamesMessage.style.display = 'none';
            
            games.forEach(game => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${game.gameName || 'Partida de ' + game.host}</td>
                    <td>${game.host}</td>
                    <td>${game.connectedPlayers}/${game.requiredPlayers}</td>
                    <td>${game.gameMode} jugadores</td>
                    <td><button class="join-btn" data-game-id="${game.gameId}">Unirse</button></td>
                `;
                
                gamesTableBody.appendChild(row);
            });
            
            // Añadir eventos a los botones de unirse
            document.querySelectorAll('.join-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const gameId = button.getAttribute('data-game-id');
                    selectGame(gameId);
                });
            });
            
            // Si tenemos un gameId seleccionado, actualizar su información
            if (selectedGameId) {
                const game = games.find(g => g.gameId === selectedGameId);
                if (game) {
                    selectedGameInfo.textContent = `${game.gameName || 'Partida de ' + game.host} (${game.connectedPlayers}/${game.requiredPlayers} jugadores)`;
                    submitJoinBtn.disabled = false;
                }
            }
        }
        
        // Seleccionar un juego para unirse
        function selectGame(gameId) {
            selectedGameId = gameId;
            
            const game = availableGames.find(g => g.gameId === gameId);
            if (game) {
                selectedGameInfo.textContent = `${game.gameName || 'Partida de ' + game.host} (${game.connectedPlayers}/${game.requiredPlayers} jugadores)`;
                submitJoinBtn.disabled = false;
            } else {
                selectedGameInfo.textContent = 'Juego no encontrado';
                submitJoinBtn.disabled = true;
            }
            
            // Mostrar modal de unirse
            joinGameModal.style.display = 'flex';
        }
        
        // Iniciar juego en solitario
        function playSolo(players) {
            // Crear un nombre por defecto si no hay uno guardado
            const playerName = storage.getItem('playerName') || 'Jugador';
            
            // Guardar el nombre del jugador
            sessionStorage.setItem('playerName', playerName);
            
            // Redirigir directamente a la página del juego con los parámetros adecuados
            window.location.href = `planchis.html?mode=solo&players=${players}&name=${encodeURIComponent(playerName)}`;
        }
        
        // Crear una nueva partida
        function createGame() {
            const playerName = playerNameInput.value.trim() || 'Jugador';
            const gameMode = parseInt(gameModeSelect.value);
            
            // Guardar nombre del jugador
            storage.setItem('playerName', playerName);
            sessionStorage.setItem('playerName', playerName);
            
            // Si estamos en modo offline, ir directamente al juego local
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                playSolo(gameMode);
                return;
            }
            
            // Crear nombre para la partida basado en el nombre del jugador
            const gameName = `Partida de ${playerName}`;
            
            websocket.send(JSON.stringify({
                type: 'create_game',
                hostName: playerName,
                gameName: gameName,
                gameMode: gameMode
            }));
            
            // Cerrar el modal
            createGameModal.style.display = 'none';
        }
        
        // Unirse a una partida existente
        function joinGame() {
            const playerName = joinPlayerNameInput.value.trim() || 'Jugador';
            
            // Guardar nombre del jugador
            storage.setItem('playerName', playerName);
            sessionStorage.setItem('playerName', playerName);
            
            if (!selectedGameId) {
                alert('Por favor, selecciona una partida');
                return;
            }
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'join_game',
                    gameId: selectedGameId,
                    playerName: playerName
                }));
                
                // Cerrar el modal
                joinGameModal.style.display = 'none';
            } else {
                alert('No se pudo conectar al servidor. Intenta jugar en modo local.');
            }
        }
        
        // Copiar enlace al portapapeles
        function copyToClipboard(text) {
            try {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        alert('¡Texto copiado al portapapeles!');
                    })
                    .catch(err => {
                        console.error('Error al copiar el texto: ', err);
                        fallbackCopyTextToClipboard(text);
                    });
            } catch (e) {
                fallbackCopyTextToClipboard(text);
            }
        }
        
        // Método alternativo para copiar al portapapeles (para navegadores antiguos)
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('¡Texto copiado al portapapeles!');
            } catch (err) {
                console.error('Error al copiar el texto: ', err);
                alert('No se pudo copiar el texto. Por favor, cópialo manualmente.');
            }
            
            document.body.removeChild(textArea);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar nombre de jugador guardado
            const savedPlayerName = storage.getItem('playerName');
            if (savedPlayerName) {
                playerNameInput.value = savedPlayerName;
                joinPlayerNameInput.value = savedPlayerName;
            }
            
            // Iniciar conexión al servidor
            connectToServer();
        });
                
        // Botones principales
        playSoloBtn2.addEventListener('click', () => playSolo(2));
        playSoloBtn4.addEventListener('click', () => playSolo(4));
        
        createGameBtn.addEventListener('click', () => {
            createGameModal.style.display = 'flex';
        });
        
        showGamesBtn.addEventListener('click', () => {
            gamesList.style.display = 'block';
            fetchAvailableGames();
        });
        
        refreshGamesBtn.addEventListener('click', fetchAvailableGames);
        
        copyLinkBtn.addEventListener('click', () => {
            copyToClipboard(shareLink.textContent);
        });
        
        showEmbedBtn.addEventListener('click', (e) => {
            e.preventDefault();
            embedModal.style.display = 'flex';
        });
        
        closeEmbedBtn.addEventListener('click', () => {
            embedModal.style.display = 'none';
        });
        
        copyEmbedBtn.addEventListener('click', () => {
            copyToClipboard(embedCode.value);
        });
        
        // Botones de modales
        cancelCreateBtn.addEventListener('click', () => {
            createGameModal.style.display = 'none';
        });
        
        submitCreateBtn.addEventListener('click', createGame);
        
        cancelJoinBtn.addEventListener('click', () => {
            joinGameModal.style.display = 'none';
            selectedGameId = null;
        });
        
        submitJoinBtn.addEventListener('click', joinGame);
        
        // Cerrar modales al hacer clic fuera de ellos
        window.addEventListener('click', (event) => {
            if (event.target === createGameModal) {
                createGameModal.style.display = 'none';
            }
            if (event.target === joinGameModal) {
                joinGameModal.style.display = 'none';
                selectedGameId = null;
            }
            if (event.target === embedModal) {
                embedModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>